# План поэтапной доработки утилиты batmon

## Принципы разработки

- Простота и читаемость кода
- Никаких ненужных абстракций
- Практическая польза каждого улучшения
- Постепенное развитие функциональности

## Этап 1: Улучшение сбора данных (приоритет: высокий)

### 1.1 Добавление температуры батареи

- Расширить структуру `Measurement` полем `Temperature int`
- Добавить парсинг температуры в `parseSystemProfiler()`
- Обновить схему БД (добавить колонку `temperature`)
- **Зачем**: критический показатель здоровья батареи

### 1.2 Включение режима WAL для SQLite

- Добавить `PRAGMA journal_mode=WAL` при инициализации БД
- **Зачем**: устранить блокировки при одновременном чтении/записи

### 1.3 Оптимизация частоты опроса

- Разделить сбор данных: `pmset` каждые 30 сек, `system_profiler` каждые 2 минуты
- Добавить переменную `lastProfilerCall` для отслеживания
- **Зачем**: `system_profiler` тяжелая операция, а проценты меняются быстрее емкостей

## Этап 2: Улучшение аналитики (приоритет: высокий)

### 2.1 Расширение обнаружения аномалий

- Добавить нормализацию порогов на время (>40%/мин вместо фиксированных 20%)
- Ввести детектор циклов заряда-разряда
- Добавить анализ эффективности зарядки
- **Зачем**: более точное выявление проблем

### 2.2 Анализ трендов

- Функция `analyzeCapacityTrend()` для отслеживания деградации за последние 30 дней
- Простое линейное сглаживание для прогноза
- **Зачем**: предсказание срока службы батареи

### 2.3 Улучшение рекомендаций

- Добавить рекомендации на основе температуры
- Персонализированные советы по режимам энергосбережения
- **Зачем**: более полезные советы пользователю

## Этап 3: Улучшение интерфейса (приоритет: средний)

### 3.1 Цветовое оформление терминала

- Добавить зависимость `github.com/fatih/color`
- Раскрасить критические значения (красный), нормальные (зеленый)
- Добавить больше эмодзи для статусов
- **Зачем**: улучшение UX, быстрое визуальное восприятие

### 3.2 Улучшение дашборда

- Добавить график температуры
- Горячие клавиши для переключения между видами (t - температура, c - емкость)
- Показ осей времени на графиках
- **Зачем**: более информативный интерактивный режим

### 3.3 Структурирование отчета

- Использовать `github.com/olekukonko/tablewriter` для красивых таблиц
- Добавить секцию "Краткое резюме" в начало
- Локализовать время (показывать в часовом поясе пользователя)
- **Зачем**: более читаемый и профессиональный отчет

## Этап 4: Экспорт данных (приоритет: низкий)

### 4.1 Экспорт в Markdown

- Добавить флаг `--output file.md`
- Генерация Markdown-отчета с таблицами и форматированием
- **Зачем**: возможность сохранения отчетов для истории

### 4.2 Экспорт в HTML с графиками

- Интеграция с простой JS-библиотекой для графиков (Chart.js)
- Генерация самодостаточного HTML файла
- **Зачем**: красивые отчеты для демонстрации/архивирования

## Этап 5: Оптимизация производительности (приоритет: низкий)

### 5.1 Буферизация в памяти

- Хранить последние 100 измерений в памяти (slice)
- Обновлять дашборд из памяти, синхронизация с БД раз в минуту
- **Зачем**: снижение нагрузки на диск, быстрее отклик UI

### 5.2 Ретенция данных

- Простая очистка записей старше 3 месяцев
- Функция `cleanupOldData()` с PRAGMA для VACUUM
- **Зачем**: предотвращение неограниченного роста БД

## Этап 6: Дополнительные метрики (приоритет: очень низкий)

### 6.1 Анализ статуса батареи Apple

- Парсинг поля `Condition` из `system_profiler`
- Уведомления при статусе отличном от "Normal"
- **Зачем**: использование встроенной диагностики Apple

### 6.2 Анализ напряжения и тока

- Добавление полей `Voltage` и `Amperage`
- Расчет мгновенной мощности (Вт)
- **Зачем**: более глубокая диагностика для энтузиастов

## Техническая реализация по этапам

### Этап 1 - изменения кода

```go
// Обновление структуры
type Measurement struct {
    // ... существующие поля
    Temperature int `db:"temperature"`
}

// Новая схема БД
schema := `CREATE TABLE IF NOT EXISTS measurements (
    // ... существующие поля  
    temperature INTEGER
);
PRAGMA journal_mode=WAL;`

// Разделение опроса
type DataCollector struct {
    lastProfilerCall time.Time
    profileInterval  time.Duration // 2 минуты
    pmsetInterval   time.Duration  // 30 секунд
}
```

### Этап 2 - новые функции

```go
func analyzeCapacityTrend(measurements []Measurement) TrendAnalysis
func detectChargeCycles(measurements []Measurement) []ChargeCycle
func normalizeAnomalyThresholds(interval time.Duration) AnomalyThresholds
```

### Этап 3 - UI улучшения

```go
import "github.com/fatih/color"

func printColoredStatus(status string, value interface{}) {
    switch status {
    case "critical": color.Red("%s: %v", status, value)
    case "good": color.Green("%s: %v", status, value)
    default: fmt.Printf("%s: %v", status, value)
    }
}
```

## Критерии готовности этапов

- **Этап 1**: Температура отображается в дашборде и отчете, нет блокировок БД
- **Этап 2**: Аномалии детектируются точнее, есть прогноз деградации
- **Этап 3**: Отчет цветной и структурированный, дашборд с переключением видов
- **Этап 4**: Можно экспортировать отчет в файл
- **Этап 5**: Дашборд работает плавно, БД не растет бесконечно
- **Этап 6**: Полная диагностика на уровне профессиональных утилит

## Ожидаемые результаты

После реализации всех этапов утилита станет:

- **Надежнее**: WAL режим, лучшая аналитика
- **Информативнее**: температура, тренды, прогнозы
- **Красивее**: цвета, структурированный вывод, графики
- **Практичнее**: экспорт отчетов, персонализированные рекомендации

При этом код останется простым и понятным, без излишних абстракций.
