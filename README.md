````# 🔋 BatMon - Интеллектуальный мониторинг батареи MacBook
  
  *Продвинутая консольная утилита для мониторинга и анализа состояния батареи MacBook с цветным интерфейсом, аналитикой трендов, экспортом отчетов и персонализированными рекомендациями.*
</div>

## ✨ Новые возможности в v2.0

### 🎨 Улучшенный интерфейс
- 🌈 **Цветной вывод** - критические значения красным, нормальные зеленым
- 😊 **Эмодзи индикаторы** - визуальные маркеры состояния (🔋, ⚡, 🌡️, ⚠️)
- 📊 **Структурированные отчеты** - краткое резюме, таблицы с выравниванием
- 🕐 **Локализация времени** - отображение в местном часовом поясе

### 📈 Расширенная аналитика
- 🌡️ **Мониторинг температуры** - отслеживание нагрева батареи
- 📉 **Анализ трендов** - прогноз деградации на основе 30-дневной истории
- 🔄 **Детекция циклов** - анализ полных циклов заряда-разряда
- ⚡ **Нормализованные пороги** - аномалии учитывают интервалы времени
- 🎯 **Персонализированные рекомендации** - советы на основе температуры и паттернов использования

### 🆕 Экспорт отчетов (Этап 4)
- 📝 **Markdown отчеты** - детальные отчеты с таблицами и статистикой
- 🌐 **HTML отчеты** - интерактивные отчеты с графиками Chart.js
- 📊 **Командная строка экспорт** - флаги `-export-md` и `-export-html`
- 🔇 **Тихий режим** - флаг `-quiet` для автоматизации

### ⚡ Оптимизация производительности (Этап 5)
- 💾 **Буферизация в памяти** - последние 100 измерений в RAM для быстрого доступа
- 🧹 **Автоматическая ретенция** - очистка данных старше 3 месяцев
- 📈 **Статистика использования** - мониторинг размера буфера и БД
- ⚡ **Сокращение запросов к БД** на 80% для частых операций

### 🔬 Расширенные метрики (Этап 6)
- ⚡ **Напряжение** - мониторинг напряжения батареи в мВ
- 🔌 **Ток заряда/разряда** - анализ тока в мА (положительный = заряд, отрицательный = разряд)
- 💡 **Мощность** - вычисляемая мощность в мВт (P = U × I)
- 🍎 **Статус Apple** - официальный статус от Apple (Normal, Service Recommended, Replace Soon)
- 📊 **6 новых метрик эффективности** - комплексная оценка здоровья батареи="center">
  <img src="logo.png" alt="BatMon Logo" width="200"/>
  
# 🔋 BatMon - Интеллектуальный мониторинг батареи MacBook
  
  *Продвинутая консольная утилита для мониторинга и анализа состояния батареи MacBook с цветным интерфейсом, аналитикой трендов и персонализированными рекомендациями.*
</div>

## ✨ Новые возможности в v2.0

### 🎨 Улучшенный интерфейс
- 🌈 **Цветной вывод** - критические значения красным, нормальные зеленым
- 😊 **Эмодзи индикаторы** - визуальные маркеры состояния (🔋, ⚡, 🌡️, ⚠️)
- 📊 **Структурированные отчеты** - краткое резюме, таблицы с выравниванием
- � **Локализация времени** - отображение в местном часовом поясе

### 📈 Расширенная аналитика
- 🌡️ **Мониторинг температуры** - отслеживание нагрева батареи
- 📉 **Анализ трендов** - прогноз деградации на основе 30-дневной истории
- 🔄 **Детекция циклов** - анализ полных циклов заряда-разряда
- ⚡ **Нормализованные пороги** - аномалии учитывают интервалы времени
- 🎯 **Персонализированные рекомендации** - советы на основе температуры и паттернов использования

### 🔧 Технические улучшения
- 💾 **WAL режим SQLite** - устранение блокировок при одновременном чтении/записи
- ⚡ **Оптимизированная частота опроса** - `pmset` каждые 30 сек, `system_profiler` каждые 2 мин
- 🔍 **Улучшенные алгоритмы** - робастная статистика с исключением выбросов

## 🎯 Как это работает

### При работе от батареи

- 📊 **Интерактивный дашборд** с графиками температуры и емкости
- 🔄 **Фоновый сбор данных** с оптимизированной частотой опроса
- ⚡ **Автоматическое обновление** каждые 10 секунд

### При работе от сети

- 📋 **Цветной отчет** по сохраненным данным с анализом трендов
- 🔮 **Прогнозы** срока службы батареи
- 💡 **Рекомендации** по оптимизации работы

## 🚀 Установка

### Требования

- macOS (протестировано на Apple Silicon)
- Go 1.24+
- MacBook с батареей

### Установка из исходников

```bash
git clone https://github.com/region23/batmon.git
cd batmon
go mod tidy
go build -o batmon
```

## 📋 Использование

### 🎯 Интерактивный режим (рекомендуется)

Новый удобный интерактивный интерфейс с цветным меню и эмодзи:

```bash
./batmon
```

**Доступные опции в меню:**
- **1️⃣ Интерактивный мониторинг** - автоматический режим с дашбордом или отчетами
- **2️⃣ Детальный отчет** - просмотр аналитики по сохраненным данным  
- **3️⃣ Экспорт отчетов** - сохранение в Markdown или HTML
- **4️⃣ Статистика и настройки** - информация о базе данных и системе
- **5️⃣ Справка** - подробная документация
- **0️⃣ Выход** - завершение программы

Программа автоматически определит состояние питания и предложит оптимальные действия.

### 🔧 Командная строка (для автоматизации)

Для скриптов и автоматизации доступны традиональные флаги:

```bash
# Экспорт в Markdown
./batmon -export-md battery_report

# Экспорт в HTML с интерактивными графиками
./batmon -export-html battery_report

# Экспорт в оба формата
./batmon -export-md report -export-html report

# Тихий режим (без вывода в консоль)
./batmon -export-md report -quiet

# Показать справку по флагам
./batmon --help
```

### Примеры созданных файлов

- `battery_report.md` - Markdown отчет с детальной статистикой и таблицами
- `battery_report.html` - HTML отчет с интерактивными графиками Chart.js

## 🎨 Дашборд v2.0

При работе от батареи вы увидите улучшенный интерактивный дашборд:

```
┌─── Заряд батареи (%) ─────────┐┌─── Текущая емкость (мАч) ────┐
│                               ││                              │
│     ████████████████████      ││     ████████████████████     │
│                               ││                              │
└───────────────────────────────┘└──────────────────────────────┘

┌─── Текущее состояние ─────────┐┌─ Заряд батареи ─┐
│ 🔋 Заряд: 87%                 ││ ████████████ 87%│
│ ⚡ Состояние: 🔋 Discharging   │├─ Износ батареи ──┤
│ 🔄 Циклы: 245                 ││ ███████        7%│
│ 📉 Износ: 7.2%                │├─ Последние измер─┤
│ ⏱️  Скорость: 458 мАч/ч       ││ Время  │Заряд│...│
│ ⏰ Время: 4h 12m              ││ 14:30  │ 89% │...│
│ 🌡️ Температура: 28°C          ││ 14:31  │ 88% │...│
│                               ││ 14:32  │ 87% │...│
│ Здоровье: Хорошее (85/100)    │└─────────────────┘
│                               │
│ Нажмите 'q' для выхода       │
│ Нажмите 'r' для обновления   │
└───────────────────────────────┘
```

## 📊 Расширенная аналитика

### Краткое резюме

```
💼 === КРАТКОЕ РЕЗЮМЕ ===
Здоровье батареи: Хорошее (рейтинг 85/100)
Циклы: 245
Износ: 7.2%
Оставшееся время: 4h 12m
```

### Анализ здоровья батареи v2.0

```
=== Анализ здоровья батареи ===
Общее состояние: Хорошее (оценка: 85/100)
Износ батареи: 7.2%
📈 Тренд деградации: -0.3% в месяц
🔮 Прогноз до 80% емкости: ~890 дней

⚠️  Обнаружено аномалий за последние измерения: 2
  • Резкое падение заряда: 85% → 60% за 2.1 мин (12:34:56)
  • Высокая температура батареи (42°C) за 1.0 мин (13:45:20)

💡 Рекомендации:
  • Повышенная температура батареи - рассмотрите улучшение охлаждения
  • Проверьте настройки энергосбережения
```

### Новые метрики

- 🌡️ **Температура батареи** - мониторинг перегрева (критично >40°C)
- 📈 **Тренд деградации** - процент деградации в месяц
- 🔮 **Прогноз срока службы** - дни до падения емкости до 80%
- ⚡ **Нормализованные аномалии** - пороги адаптируются к интервалам измерений
- ⚡ **Напряжение** - мониторинг напряжения батареи (мВ)
- 🔌 **Ток заряда/разряда** - анализ силы тока (мА)
- 💡 **Мощность** - вычисляемая мощность энергопотребления (мВт)
- 🍎 **Статус Apple** - официальная диагностика от Apple
- 📊 **Комплексные метрики** - эффективность, стабильность, рейтинг здоровья

## 📊 Примеры экспорта отчетов

### Markdown отчет
```markdown
# 🔋 Отчет о состоянии батареи MacBook

## 💼 Краткое резюме
- **Здоровье батареи:** Хорошее (рейтинг 85/100)
- **Циклы:** 245
- **Износ:** 6.6%
- **Оставшееся время:** 4h 12m

## 🔋 Текущее состояние батареи
| Параметр | Значение |
|----------|----------|
| Заряд | 87% |
| Состояние | Discharging |
| Напряжение | 12456 мВ |
| Ток | -1234 мА |
| Мощность | 15375 мВт |
| Статус Apple | Normal |
```

### HTML отчет с графиками
- Интерактивные графики заряда и емкости с Chart.js
- Responsive дизайн для просмотра на любых устройствах
- Цветовая кодировка состояний и метрик
- Детальные таблицы с последними измерениями

### Цветовые индикаторы

- 🟢 **Зеленый** - отличное состояние (износ <10%, заряд >50%, температура <30°C)
- 🟡 **Желтый** - требует внимания (износ 10-20%, заряд 20-50%, температура 30-40°C)  
- 🔴 **Красный** - критическое состояние (износ >20%, заряд <20%, температура >40°C)

## 🗄️ База данных v2.0

Обновленная структура с поддержкой расширенных метрик и WAL режимом:

```sql
CREATE TABLE measurements (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp TEXT NOT NULL,
    percentage INTEGER,
    state TEXT,
    cycle_count INTEGER,
    full_charge_capacity INTEGER,
    design_capacity INTEGER,
    current_capacity INTEGER,
    temperature INTEGER DEFAULT 0,      -- Температура батареи (°C)
    voltage INTEGER DEFAULT 0,          -- Напряжение (мВ)
    amperage INTEGER DEFAULT 0,         -- Ток заряда/разряда (мА)
    power INTEGER DEFAULT 0,            -- Мощность (мВт)
    apple_condition TEXT DEFAULT ''     -- Статус от Apple
);
PRAGMA journal_mode=WAL;  -- Оптимизация для конкурентного доступа
```

### Новые расширенные метрики

- **PowerEfficiency** - эффективность энергопотребления (0-100)
- **VoltageStability** - стабильность напряжения (коэффициент вариации)
- **ChargingEfficiency** - эффективность процесса зарядки
- **PowerTrend** - анализ тренда энергопотребления (растущее/снижающееся/стабильное)
- **HealthRating** - комплексный рейтинг здоровья батареи (0-100)
- **AppleStatus** - интеграция с официальным статусом Apple

## 🔧 Конфигурация v2.0

### Интервалы опроса

```go
const (
    pmsetInterval     = 30 * time.Second // Быстрые данные (заряд)
    profilerInterval  = 2 * time.Minute  // Медленные данные (емкость, температура)
)
```

### Пороги аномалий

- **Заряд**: >40% в минуту (нормализовано по времени)
- **Емкость**: >500 мАч за интервал
- **Температура**: >40°C критично, >35°C предупреждение

## 🎯 Практические сценарии

### Обнаружение проблем

```bash
# Запуск при подозрении на проблемы с батареей
./batmon

# Цветной отчет покажет:
# 🔴 Высокая температура батареи (45°C) - КРИТИЧНО
# 🟡 Быстрая деградация (-1.2% в месяц) - ПРЕДУПРЕЖДЕНИЕ  
# ⚡ Нестабильное напряжение (стабильность 82%) - ВНИМАНИЕ
# 💡 Рекомендация: Избегайте работы от батареи при высоких нагрузках
```

### Создание отчетов для сервиса

```bash
# Создание детального отчета для технической поддержки
./batmon -export-html tech_report -export-md tech_report

# Отчет будет содержать:
# • Полную историю измерений
# • Графики трендов деградации  
# • Анализ напряжения, тока и мощности
# • Официальный статус Apple
# • Рекомендации по оптимизации
```

### Мониторинг здоровья

```bash
# Еженедельная проверка состояния
./batmon

# Краткий отчет:
# 💼 Здоровье батареи: Отличное (95/100)
# 📈 Тренд: -0.1% в месяц (норма)
# 🔮 Прогноз: батарея прослужит еще 3+ года
# ⚡ Энергоэффективность: 87%
# 🍎 Статус Apple: Normal
```

### Автоматизированные отчеты

```bash
# Создание ежедневных отчетов в cron
0 9 * * * cd /path/to/batmon && ./batmon -export-md daily_$(date +\%Y\%m\%d) -quiet

# Результат: файлы daily_20250806.md с полной статистикой
```

### Оптимизация использования

- 🌡️ **Следите за температурой** - избегайте нагрузки при >40°C
- 🔄 **Калибруйте батарею** при износе >15% и >500 циклов
- ⚡ **Оптимизируйте зарядку** - не держите постоянно на 100%
- ⚡ **Контролируйте мощность** - высокое энергопотребление >15 Вт требует внимания
- 🔌 **Анализируйте ток** - резкие скачки могут указывать на проблемы
- 🍎 **Следите за статусом Apple** - при "Service Recommended" обратитесь в сервис
- 📊 **Используйте экспорт** - создавайте отчеты для отслеживания трендов

## 🐛 Устранение неполадок v2.0

### Нет данных о температуре

```bash
# Проверьте доступность данных
system_profiler SPPowerDataType | grep Temperature
```

### Цвета не отображаются

```bash
# Проверьте поддержку цветов в терминале
export TERM=xterm-256color
```

### Медленная работа дашборда

- WAL режим SQLite устраняет блокировки
- Оптимизированные интервалы опроса снижают нагрузку

## 🤝 Вклад в проект

Проект следует принципам из `refactoring.md`:
- ✅ Простота и читаемость кода
- ✅ Никаких ненужных абстракций  
- ✅ Практическая польза каждого улучшения
- ✅ Постепенное развитие функциональности

## 📈 Roadmap

### ✅ Этап 1-3: Базовая функциональность (ЗАВЕРШЕНО)
- ✅ **Цветной интерфейс** - эмодзи, цветовые индикаторы
- ✅ **Расширенная аналитика** - тренды, циклы, температура
- ✅ **Технические улучшения** - WAL режим, оптимизация опроса

### ✅ Этап 4: Экспорт данных (ЗАВЕРШЕНО)
- ✅ **Markdown отчеты** - сохранение детальных отчетов в файлы
- ✅ **HTML с графиками** - интерактивные отчеты для браузера с Chart.js
- ✅ **Флаги командной строки** - `-export-md`, `-export-html`, `-quiet`

### ✅ Этап 5: Оптимизация производительности (ЗАВЕРШЕНО)
- ✅ **Буферизация в памяти** - последние 100 измерений в RAM
- ✅ **Ретенция данных** - автоочистка записей старше 3 месяцев
- ✅ **Статистика производительности** - мониторинг использования ресурсов

### ✅ Этап 6: Дополнительные метрики (ЗАВЕРШЕНО)
- ✅ **Анализ напряжения и тока** - глубокая диагностика энергопотребления
- ✅ **Статус батареи Apple** - интеграция с официальной диагностикой
- ✅ **6 новых метрик эффективности** - комплексная оценка состояния

### 🔮 Будущие улучшения
- 📱 **Web-интерфейс** - удаленный мониторинг через браузер
- 📧 **Уведомления** - алерты при критических состояниях
- 📊 **Исторические графики** - долгосрочные тренды за месяцы/годы

## 📄 Лицензия

Этот проект распространяется под лицензией MIT.

## 🙏 Благодарности

- [gizak/termui](https://github.com/gizak/termui) - библиотека для создания UI в терминале
- [jmoiron/sqlx](https://github.com/jmoiron/sqlx) - расширения для database/sql
- [mattn/go-sqlite3](https://github.com/mattn/go-sqlite3) - SQLite драйвер для Go
- [fatih/color](https://github.com/fatih/color) - цветной вывод в терминале

---

🚀 **v2.0** - Полнофункциональный мониторинг с экспортом, буферизацией и расширенными метриками  
✅ **Этапы 1-6 завершены** - все планируемые функции реализованы  
Сделано с ❤️ для пользователей MacBook

````
