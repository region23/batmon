name: üöÄ Build and Release

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      version:
        description: '–í–µ—Ä—Å–∏—è —Ä–µ–ª–∏–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: v1.0.2)'
        required: true
        default: 'v1.0.0'
        type: string
      prerelease:
        description: '–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ pre-release (—Ç–µ—Å—Ç–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)'
        required: false
        default: false
        type: boolean
      draft:
        description: '–°–æ–∑–¥–∞—Ç—å –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üîß Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: üì¶ Install dependencies
      run: go mod tidy

    - name: üî® Build for multiple platforms
      run: |
        # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±–∏–ª–¥–æ–≤
        mkdir -p dist
        
        # Linux AMD64
        GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o dist/batmon-linux-amd64
        
        # Linux ARM64
        GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o dist/batmon-linux-arm64
        
        # macOS AMD64 (Intel)
        GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o dist/batmon-darwin-amd64
        
        # macOS ARM64 (Apple Silicon)
        GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o dist/batmon-darwin-arm64
        
        # Windows AMD64
        GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o dist/batmon-windows-amd64.exe
        
        # Windows ARM64
        GOOS=windows GOARCH=arm64 go build -ldflags="-s -w" -o dist/batmon-windows-arm64.exe

    - name: üì¶ Create archives
      run: |
        cd dist
        
        # –°–æ–∑–¥–∞–µ–º tar.gz –¥–ª—è Unix-–ø–æ–¥–æ–±–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
        tar -czf batmon-linux-amd64.tar.gz batmon-linux-amd64
        tar -czf batmon-linux-arm64.tar.gz batmon-linux-arm64
        tar -czf batmon-darwin-amd64.tar.gz batmon-darwin-amd64
        tar -czf batmon-darwin-arm64.tar.gz batmon-darwin-arm64
        
        # –°–æ–∑–¥–∞–µ–º zip –¥–ª—è Windows
        zip batmon-windows-amd64.zip batmon-windows-amd64.exe
        zip batmon-windows-arm64.zip batmon-windows-arm64.exe
        
        # –°–æ–∑–¥–∞–µ–º checksums
        sha256sum *.tar.gz *.zip > checksums.txt

    - name: üìä Get version info
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          echo "is_manual=true" >> $GITHUB_OUTPUT
        elif [[ $GITHUB_REF == refs/tags/* ]]; then
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "is_manual=false" >> $GITHUB_OUTPUT
        else
          echo "ERROR: Workflow triggered unexpectedly" >&2
          exit 1
        fi

    - name: üè∑Ô∏è Create tag for manual release
      if: steps.version.outputs.is_manual == 'true'
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git tag -a ${{ steps.version.outputs.version }} -m "Release ${{ steps.version.outputs.version }}"
        git push origin ${{ steps.version.outputs.version }}

    - name: üöÄ Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        files: |
          dist/*.tar.gz
          dist/*.zip
          dist/checksums.txt
        draft: ${{ github.event.inputs.draft == 'true' }}
        prerelease: ${{ github.event.inputs.prerelease == 'true' }}
        body: |
          ## üîã BatMon ${{ steps.version.outputs.version }}
          
          –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–∞—Ç–∞—Ä–µ–∏ MacBook —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π.
          
          ### üì• –ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞
          
          **–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Go:**
          ```bash
          go install github.com/region23/batmon@${{ steps.version.outputs.version }}
          ```
          
          **–î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö - —Å–∫–∞—á–∞–π—Ç–µ –≥–æ—Ç–æ–≤—ã–π –±–∏–Ω–∞—Ä–Ω–∏–∫:**
          
          #### üçé macOS
          - **Apple Silicon (M1/M2/M3)**: `batmon-darwin-arm64.tar.gz`
          - **Intel**: `batmon-darwin-amd64.tar.gz`
          
          #### üêß Linux
          - **AMD64/x86_64**: `batmon-linux-amd64.tar.gz`
          - **ARM64**: `batmon-linux-arm64.tar.gz`
          
          #### ü™ü Windows
          - **AMD64/x86_64**: `batmon-windows-amd64.zip`
          - **ARM64**: `batmon-windows-arm64.zip`
          
          ### üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
          
          1. –°–∫–∞—á–∞–π—Ç–µ –∞—Ä—Ö–∏–≤ –¥–ª—è –≤–∞—à–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
          2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ: `tar -xzf batmon-*.tar.gz` –∏–ª–∏ —Ä–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä—É–π—Ç–µ zip
          3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: `./batmon` (–∏–ª–∏ `batmon.exe` –Ω–∞ Windows)
          4. –í—ã–±–µ—Ä–∏—Ç–µ "–ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –±–∞—Ç–∞—Ä–µ–∏ (100% ‚Üí 0%)" –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
          
          ### ‚ú® –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
          - üîã –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –±–∞—Ç–∞—Ä–µ–∏ –æ—Ç 100% –¥–æ 0%
          - üìä –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
          - üìÑ –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–æ–≤ –≤ HTML/Markdown
          - üå°Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –±–∞—Ç–∞—Ä–µ–∏
          - üí° –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∑–∞–º–µ–Ω–µ
          - üéØ –ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—å (macOS, Linux, Windows)
          
          ### üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
          - ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã: `sha256sum -c checksums.txt`
          - ‚úÖ –ö–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫—Ä—ã—Ç—ã–π –Ω–∞ [GitHub](https://github.com/region23/batmon)
          
          ### üìä –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
          - ‚úÖ **macOS**: 12.0+ (Monterey –∏ –Ω–æ–≤–µ–µ)
          - ‚úÖ **Linux**: –õ—é–±–æ–π –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤ —Å systemd (Ubuntu, CentOS, etc)
          - ‚úÖ **Windows**: 10+ (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: üì§ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: batmon-${{ steps.version.outputs.version }}
        path: |
          dist/*.tar.gz
          dist/*.zip
          dist/checksums.txt
        retention-days: 30